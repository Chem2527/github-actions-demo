name: Deploy .NET Application to Windows EC2 with IIS

on:
  push:
    branches:
      - main  # Replace with the branch you want to deploy from

jobs:
  deploy:
    runs-on: windows-latest  # GitHub hosted runner for Windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'  # Replace with your .NET version
          
      - name: Navigate to project directory
        run: cd DummyDotNetApp

      - name: Publish .NET application
        run: |
          dotnet restore DummyDotNetApp.csproj  # Specify the .csproj file explicitly
          dotnet publish DummyDotNetApp.csproj -c Release -o ./publish  # Specify the .csproj file explicitly

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}  # Your EC2 instance IP
          username: 'Administrator'  # Your EC2 username
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}  # GitHub secret containing private key
          port: 22  # Default SSH port
          script: |
            # IIS deployment script
            New-Item -Path "C:\inetpub\wwwroot\DummyDotNetApp" -ItemType Directory -Force
            Copy-Item -Path "./publish/*" -Destination "C:\inetpub\wwwroot\DummyDotNetApp" -Recurse
            iisreset

