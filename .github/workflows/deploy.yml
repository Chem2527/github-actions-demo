name: Deploy .NET Application to Windows EC2

on:
  push:
    branches:
      - main  # Adjust the branch as necessary

jobs:
  deploy:
    runs-on: windows-latest  # This uses a GitHub-hosted Windows runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0'  # Replace with your target .NET version

      - name: Publish .NET Application
        run: |
          cd DummyDotNetApp  # Navigate to the project directory
          dotnet restore DummyDotNetApp.csproj
          dotnet publish DummyDotNetApp.csproj -c Release -o ./publish  # Publish to ./publish directory

      - name: Install Plink (for password-based SSH authentication)
        run: |
          choco install putty -y  # Install PuTTY, which includes Plink

      - name: Deploy to Windows EC2 via SSH (Password-based)
        run: |
          echo "Starting SSH deployment..."

          # Use plink to connect, bypassing host key checks
          plink.exe -batch -no-antispoof -pw "${{ secrets.EC2_PASSWORD }}" administrator@${{ secrets.EC2_PUBLIC_IP }} powershell -Command "
          $ErrorActionPreference = 'Stop';
          New-Item -Path 'C:\inetpub\wwwroot\DummyDotNetApp' -ItemType Directory -Force;
          Copy-Item -Path './publish/*' -Destination 'C:\inetpub\wwwroot\DummyDotNetApp' -Recurse;
          iisreset;
          "
